pipeline {
    agent any
    options {
        buildDiscarder(logRotator(numToKeepStr: '25'))
        disableConcurrentBuilds()
        timestamps()
        skipDefaultCheckout()
    }

    stages {
        
        stage('get code') {
            steps {
                git 'git@github.com:fuyoushengwu/weapp_server.git'
            }
        }

        stage('package') {
            steps {
                dir("sources") {
                    sh 'mvn clean package -Dmaven.test.skip=true'
                }
            }
        }

        stage('deploy') {
            steps {
                retry(5) {
                    sshPublisher(
                        publishers: [
                            sshPublisherDesc(
                                configName: '172.16.0.4-SSH', 
                                transfers: [
                                    sshTransfer(
                                        execCommand: 'rm -rf weapp/;rm -rf weapp.tar.gz;'
                                    ),
                                    sshTransfer(
                                        sourceFiles: 'sources/distribute/weapp.tar.gz',
                                        removePrefix: 'sources/distribute/', 
                                        execCommand: 'tar -zxvf weapp.tar.gz'
                                    ),
                                    sshTransfer(
                                        execCommand: './weapp/bin/deploya.sh'
                                    )
                                ], 
                                verbose: true
                            ), 
                            sshPublisherDesc(
                                configName: '172.16.0.8-SSH', 
                                transfers: [
                                    sshTransfer(
                                        execCommand: 'rm -rf *'
                                    ),
                                    sshTransfer(
                                        sourceFiles: 'sources/distribute/weapp.tar.gz',
                                        removePrefix: 'sources/distribute/', 
                                        execCommand: 'tar -zxvf weapp.tar.gz'
                                    ),
                                    sshTransfer(
                                        execCommand: './weapp/bin/deployb.sh'
                                    )
                                ], 
                                verbose: true
                            )
                        ]
                    )
                }
                

            }
        }


    }

}